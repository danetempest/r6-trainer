<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>R6 Coach Pro: Sound & Sequence Fix</title>
    <style>
        :root { --p-blue: #00d4ff; --p-gold: #ffcc00; --p-red: #ff4b4b; --bg: #09090b; --card: #18181b; }
        body { background: var(--bg); color: #fff; font-family: 'Inter', sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .lab-card { background: var(--card); padding: 30px; border-radius: 24px; border: 1px solid #27272a; width: 850px; box-shadow: 0 50px 100px rgba(0,0,0,0.9); position: relative; margin-top: 40px; }
        
        /* BACK BUTTON */
        .back-link { position: absolute; top: 20px; left: 20px; color: #666; text-decoration: none; font-weight: bold; font-family: sans-serif; display: flex; align-items: center; gap: 8px; transition: 0.2s; }
        .back-link:hover { color: var(--p-blue); }

        /* RANK DISPLAY */
        .rank-badge { position: absolute; top: 25px; right: 40px; font-size: 6rem; font-weight: 900; line-height: 1; color: #27272a; transition: 0.2s; }
        .rank-S { color: var(--p-gold); text-shadow: 0 0 40px var(--p-gold); }
        .rank-A { color: var(--p-blue); text-shadow: 0 0 20px var(--p-blue); }
        .rank-F { color: var(--p-red); }

        /* MAIN VIEWPORT */
        .viewport { height: 280px; background: #000; border-radius: 16px; margin: 20px 0; position: relative; overflow: hidden; border: 4px solid #27272a; }
        .flash-overlay { position: absolute; inset: 0; opacity: 0; transition: opacity 0.1s; pointer-events: none; }
        
        /* VISUAL ELEMENTS */
        .wall-l { position: absolute; left: 0; width: 100px; height: 100%; background: #111; border-right: 2px solid #333; z-index: 2; }
        .wall-r { position: absolute; right: 0; width: 100px; height: 100%; background: #111; border-left: 2px solid #333; z-index: 2; }
        .head-target { width: 40px; height: 40px; background: rgba(255,0,0,0.2); border: 2px solid var(--p-red); border-radius: 50%; position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); display: none; }
        
        /* CHARACTER */
        .char-model { width: 50px; height: 90px; background: var(--p-blue); border-radius: 6px; position: absolute; bottom: 0; left: 50%; margin-left: -25px; transition: transform 0.05s; z-index: 1; }

        /* COMBO BAR */
        .combo-track { display: flex; justify-content: center; gap: 12px; margin-bottom: 20px; }
        .key-node { width: 70px; height: 70px; background: #27272a; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: 800; color: #52525b; border: 2px solid transparent; transition: 0.1s; position: relative; }
        .key-node.active { border-color: var(--p-blue); color: #fff; box-shadow: 0 0 15px rgba(0,212,255,0.3); transform: scale(1.1); }
        .key-node.hit { background: var(--p-blue); color: #000; }
        .label { position: absolute; top: -18px; font-size: 0.7rem; color: #71717a; text-transform: uppercase; font-weight: bold; }

        /* STATS */
        .stats-bar { display: flex; justify-content: space-between; background: #000; padding: 15px 25px; border-radius: 12px; align-items: center; }
        .stat-group { text-align: center; }
        .stat-val { font-size: 1.4rem; font-weight: bold; color: #fff; }
        .stat-label { font-size: 0.75rem; color: #71717a; }

        .swap-btn { width: 100%; margin-top: 15px; padding: 12px; background: transparent; border: 1px dashed #3f3f46; color: #71717a; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .swap-btn:hover { border-color: var(--p-blue); color: var(--p-blue); }
    </style>
</head>
<body>

    <a href="index.html" class="back-link">
        ⬅ BACK TO MAP TRAINER
    </a>

    <div class="lab-card">
        <div id="rank-display" class="rank-badge">D</div>
        <h1 style="margin:0; font-size: 1.8rem;">PRO RHYTHM LAB <span style="color:var(--p-blue)">9.0</span></h1>
        <p style="color:#71717a; margin-top:5px;">AUDIO ENABLED • CORRECTED SEQUENCE</p>

        <div class="viewport">
            <div id="flash" class="flash-overlay"></div>
            <div class="wall-l"></div>
            <div class="wall-r"></div>
            <div style="position:absolute; top:45%; width:100%; border-top:1px dashed rgba(255,204,0,0.3);"></div>
            <div id="char" class="char-model"></div>
        </div>

        <div class="combo-track">
            <div id="k0" class="key-node"><span class="label">STEP 1</span>-</div>
            <div id="k1" class="key-node"><span class="label">STEP 2</span>-</div>
            <div id="k2" class="key-node"><span class="label">STEP 3</span>-</div>
            <div id="k3" class="key-node"><span class="label">STEP 4</span>-</div>
        </div>

        <div class="stats-bar">
            <div class="stat-group">
                <div class="stat-label">LAST TIME</div>
                <div id="time" class="stat-val">0ms</div>
            </div>
            <div class="stat-group">
                <div class="stat-label">FEEDBACK</div>
                <div id="msg" class="stat-val" style="color:var(--p-gold)">READY</div>
            </div>
            <div class="stat-group">
                <div class="stat-label">STREAK</div>
                <div id="streak" class="stat-val">0</div>
            </div>
        </div>

        <button class="swap-btn" onclick="toggleMode()">PRESS [SPACE] TO SWAP SEQUENCE</button>
    </div>

    <script>
        // 1. CONFIGURATION
        const SEQS = {
            'ADEQ': ['a', 'd', 'e', 'q'], // Right Peek
            'DAQE': ['d', 'a', 'q', 'e']  // Left Peek (User Request)
        };
        let mode = 'ADEQ';
        let idx = 0;
        let startTime = 0;
        let streak = 0;

        // 2. AUDIO ENGINE (Synthesizer)
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            if (type === 'success') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                osc.start(); osc.stop(audioCtx.currentTime + 0.3);
            } else if (type === 'click') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(300, audioCtx.currentTime);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);
                osc.start(); osc.stop(audioCtx.currentTime + 0.05);
            } else if (type === 'fail') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                osc.start(); osc.stop(audioCtx.currentTime + 0.2);
            }
        }

        // 3. LOGIC
        function init() {
            const keys = SEQS[mode];
            for (let i = 0; i < 4; i++) {
                const el = document.getElementById('k'+i);
                el.firstChild.nextSibling.nodeValue = keys[i].toUpperCase();
                el.className = 'key-node';
            }
            document.getElementById('k0').classList.add('active');
            document.getElementById('msg').innerText = mode + " MODE";
        }

        window.addEventListener('keydown', (e) => {
            const k = e.key.toLowerCase();
            
            // Spacebar Swap
            if (k === ' ') { toggleMode(); return; }

            const targetKey = SEQS[mode][idx];
            
            if (k === targetKey) {
                // CORRECT KEY
                if (idx === 0) startTime = performance.now();
                playSound('click');
                
                // Update Visuals
                document.getElementById('k'+idx).classList.remove('active');
                document.getElementById('k'+idx).classList.add('hit');
                
                // Character Movement Simulation
                const char = document.getElementById('char');
                if (mode === 'ADEQ') {
                     if(idx===0) char.style.transform = "translateX(-20px) skewX(10deg)";
                     if(idx===1) char.style.transform = "translateX(40px)";
                     if(idx===2) char.style.transform = "translateX(20px) skewX(-15deg)";
                } else {
                     if(idx===0) char.style.transform = "translateX(40px)";
                     if(idx===1) char.style.transform = "translateX(-20px) skewX(10deg)";
                     if(idx===2) char.style.transform = "translateX(0px) skewX(-15deg)";
                }

                idx++;
                
                if (idx < 4) {
                    document.getElementById('k'+idx).classList.add('active');
                } else {
                    // FINISHED SEQUENCE
                    const totalTime = (performance.now() - startTime).toFixed(0);
                    finish(totalTime);
                }

            } else if (['a','d','e','q'].includes(k)) {
                // WRONG KEY
                fail();
            }
        });

        function finish(ms) {
            document.getElementById('time').innerText = ms + 'ms';
            const rankEl = document.getElementById('rank-display');
            const flash = document.getElementById('flash');
            
            let rank = 'D';
            
            if (ms < 160) { 
                rank = 'S'; 
                playSound('success'); 
                streak++;
                flash.style.background = '#ffcc00';
            } else if (ms < 250) {
                rank = 'A';
                playSound('success'); // Still good enough for a sound
                streak++;
                flash.style.background = '#00d4ff';
            } else {
                rank = 'F';
                playSound('fail');
                streak = 0;
                flash.style.background = '#ff4b4b';
            }

            rankEl.innerText = rank;
            rankEl.className = 'rank-badge rank-' + rank;
            document.getElementById('streak').innerText = streak;
            document.getElementById('msg').innerText = rank === 'S' ? "GODLIKE" : "COMPLETE";
            
            flash.style.opacity = '0.3';
            setTimeout(reset, 500);
        }

        function fail() {
            playSound('fail');
            streak = 0;
            document.getElementById('streak').innerText = 0;
            document.getElementById('msg').innerText = "MISCLICK";
            document.getElementById('flash').style.background = '#ff4b4b';
            document.getElementById('flash').style.opacity = '0.3';
            setTimeout(reset, 200);
        }

        function reset() {
            idx = 0;
            init();
            document.getElementById('flash').style.opacity = '0';
            document.getElementById('char').style.transform = "translateX(0) skewX(0)";
        }

        function toggleMode() {
            mode = mode === 'ADEQ' ? 'DAQE' : 'ADEQ';
            streak = 0;
            document.getElementById('streak').innerText = 0;
            reset();
        }

        // Start
        init();
    </script>
</body>
</html>
