<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>R6 Coach Pro: Focus Lab</title>
    <style>
        :root { 
            --p-blue: #3b82f6; 
            --p-gold: #f59e0b; 
            --p-red: #ef4444; 
            --p-green: #10b981;
            --p-purple: #8b5cf6;
            --bg: #09090b; 
            --card: #18181b;
        }
        * { box-sizing: border-box; }
        body { 
            background: var(--bg); color: #fff; font-family: 'Inter', sans-serif; 
            display: flex; flex-direction: column; align-items: center; 
            padding: 20px; margin: 0; min-height: 100vh; overflow-x: hidden;
        }

        .back-nav { position: absolute; top: 20px; left: 20px; text-decoration: none; color: #71717a; font-weight: 700; font-size: 0.8rem; z-index: 200; }
        .back-nav:hover { color: var(--p-blue); }
        
        .lab-card { 
            background: var(--card); padding: 24px 28px; border-radius: 12px; 
            border: 1px solid #27272a; width: 950px; position: relative; margin-top: 30px; 
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
        }

        /* --- BENTO GRID STATS --- */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin: 15px 0; }
        .bento-card { 
            background: rgba(24, 24, 27, 0.6); backdrop-filter: blur(10px); 
            border: 1px solid rgba(255,255,255,0.05); border-radius: 12px; padding: 15px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative;
        }
        .card-hero { grid-column: span 2; grid-row: span 2; background: rgba(0,0,0,0.3); border-color: rgba(59, 130, 246, 0.3); }
        .card-wide { grid-column: span 2; }
        
        .stat-label { font-size: 0.65rem; color: #71717a; letter-spacing: 1px; margin-bottom: 4px; }
        .hero-val { font-size: 3.5rem; font-weight: 900; color: #fff; text-shadow: 0 0 30px rgba(59, 130, 246, 0.2); line-height: 1; }
        .stat-val { font-size: 1.2rem; font-weight: bold; color: #fff; }
        .rank-badge { position: absolute; top: 15px; right: 20px; font-size: 2rem; font-weight: 900; }
        .rank-S { color: var(--p-gold); text-shadow: 0 0 15px var(--p-gold); }

        /* --- VIEWPORT --- */
        .viewport { 
            height: 380px; background: linear-gradient(180deg, #050508 0%, #0a0a0f 100%);
            border-radius: 8px; margin: 15px 0; position: relative; overflow: hidden; 
            border: 2px solid #27272a; perspective: 1200px; perspective-origin: 50% 60%;
            transition: all 0.3s ease;
        }

        /* THEATER MODE */
        body.theater-mode { padding: 0; background: #000; justify-content: center; }
        body.theater-mode .lab-card { width: 100vw; height: 100vh; margin: 0; padding: 0; border: none; background: #000; }
        body.theater-mode .viewport { width: 100%; height: 100%; margin: 0; border: none; border-radius: 0; }
        body.theater-mode .control-panel, body.theater-mode .extras-row, body.theater-mode .daily-goal, body.theater-mode .session-info { display: none; }
        body.theater-mode .stats-grid { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 60%; pointer-events: none; z-index: 200; opacity: 0.8; }

        /* --- 3D WORLD --- */
        .world-container { position: absolute; width: 300%; height: 100%; left: -100%; top: 0; transform-style: preserve-3d; }
        .hallway { position: absolute; width: 33.33%; height: 100%; left: 33.33%; transform-style: preserve-3d; }
        .floor { position: absolute; width: 2000px; height: 2000px; left: 50%; bottom: -600px; margin-left: -1000px; background: repeating-linear-gradient(90deg, #1a1a1f 0px, #1a1a1f 48px, #222 48px, #222 50px), repeating-linear-gradient(0deg, #1a1a1f 0px, #1a1a1f 48px, #222 48px, #222 50px); transform: rotateX(85deg); }
        .wall { position: absolute; width: 800px; height: 100%; background: linear-gradient(90deg, #000, #111); }
        .wall-left { left: -300px; transform: rotateY(80deg); }
        .wall-right { right: -300px; transform: rotateY(-80deg); background: linear-gradient(-90deg, #000, #111); }
        
        .doorframe { position: absolute; width: 140px; height: 300px; left: 50%; bottom: 0; margin-left: -70px; z-index: 10; pointer-events: none; }
        .door-col { position: absolute; width: 30px; height: 100%; background: #222; border: 1px solid #333; }
        
        .enemy-target { position: absolute; bottom: 90px; width: 40px; height: 70px; z-index: 5; transition: transform 0.2s, opacity 0.2s; }
        .enemy-target.dead { opacity: 0; transform: scale(0.9); }
        .enemy-body { width: 100%; height: 100%; background: #ef4444; border-radius: 4px; box-shadow: 0 0 20px rgba(239, 68, 68, 0.4); }
        .enemy-head { position: absolute; top: -20px; left: 10%; width: 80%; height: 20px; background: #fca5a5; border-radius: 50%; }
        .spotted-tag { position: absolute; top: -30px; left: 50%; transform:translateX(-50%); font-size:0.7rem; color:var(--p-gold); font-weight:bold; opacity:0; }
        .enemy-target.spotted .spotted-tag { opacity: 1; }

        /* WEAPON & HUD */
        .weapon-container { position: absolute; bottom: 0; left: 50%; width: 200px; height: 160px; margin-left: -100px; z-index: 50; pointer-events: none; }
        .weapon-model { position: absolute; bottom: -20px; left: 50%; margin-left: -40px; transition: transform 0.05s ease-out; }
        .gun-body { width: 80px; height: 45px; background: #222; border-radius: 4px; border: 1px solid #444; position: relative; }
        .gun-optic { position: absolute; top: -15px; left: 20px; width: 40px; height: 15px; background: #111; border: 1px solid var(--p-blue); box-shadow: 0 0 5px var(--p-blue); }
        .muzzle-flash { position: absolute; top: -20px; right: -50px; width: 60px; height: 60px; background: radial-gradient(#fff, #f59e0b, transparent); border-radius: 50%; opacity: 0; transform: scale(0.5); }
        .muzzle-flash.active { opacity: 1; transform: scale(1.5); transition: 0.05s; }

        .crosshair { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 4px; height: 4px; background: #fff; border-radius: 50%; box-shadow: 0 0 4px #fff; z-index: 100; }
        .feedback-text { position: absolute; top: 20%; left: 50%; transform: translateX(-50%); font-size: 2rem; font-weight: 900; opacity: 0; transition: 0.2s; z-index: 100; text-shadow: 0 4px 10px rgba(0,0,0,0.8); }
        .feedback-text.show { opacity: 1; top: 15%; }
        
        .phase-indicator { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); font-size: 0.7rem; padding: 4px 10px; background: rgba(0,0,0,0.8); border-radius: 4px; z-index: 90; font-weight: bold; }
        .phase-indicator.intel { color: var(--p-gold); border: 1px solid rgba(245, 158, 11, 0.4); }
        .phase-indicator.kill { color: var(--p-red); border: 1px solid rgba(239, 68, 68, 0.4); }

        .theater-btn { position: absolute; top: 15px; right: 15px; z-index: 200; background: rgba(0,0,0,0.6); border: 1px solid #333; color: #fff; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.7rem; }
        
        /* NEW HUD KEYS */
        .combo-track { 
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); 
            z-index: 80; display: flex; gap: 8px; 
        }
        .key-node { 
            width: 40px; height: 40px; background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.2); 
            border-radius: 6px; display: flex; align-items: center; justify-content: center; 
            font-size: 1rem; font-weight: 800; color: rgba(255,255,255,0.5); transition: 0.1s; 
            text-shadow: 0 2px 4px #000;
        }
        .key-node.active { opacity: 1; border-color: var(--p-blue); color: #fff; box-shadow: 0 0 10px rgba(59, 130, 246, 0.4); }
        .key-node.hit { background: var(--p-blue); border-color: var(--p-blue); color: #fff; }

        .exposure-bar-container { position: absolute; bottom: 10px; left: 50%; transform:translateX(-50%); width: 200px; height: 4px; background: rgba(0,0,0,0.5); border-radius: 2px; z-index: 80; opacity: 0; }
        .exposure-bar-container.active { opacity: 1; }
        .exposure-bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--p-green), var(--p-red)); }

        /* --- CONTROLS --- */
        .control-panel { display: flex; flex-direction: column; gap: 15px; width: 100%; margin-bottom: 15px; }
        .top-row { display: flex; gap: 15px; width: 100%; }
        
        /* DROPDOWN STYLE */
        .mode-select { 
            flex: 1; background: #111; color: #fff; border: 1px solid #333; padding: 10px; 
            border-radius: 6px; font-family: 'Inter', sans-serif; font-size: 0.8rem; cursor: pointer; 
        }
        
        .difficulty-row { display: flex; gap: 8px; flex: 2; }
        .diff-btn { flex: 1; background: #111; border: 1px solid #333; color: #666; border-radius: 6px; cursor: pointer; font-size: 0.7rem; font-weight: bold; }
        .diff-btn.active { background: #222; color: #fff; border-color: var(--p-blue); }

        .rhythm-bar { 
            display: flex; justify-content: space-between; align-items: center; 
            background: #0f0f12; padding: 10px 15px; border-radius: 8px; border: 1px solid #27272a; 
        }
        .bpm-slider { width: 120px; }
        .beat-dots { display: flex; gap: 6px; }
        .beat-dot { width: 8px; height: 8px; background: #333; border-radius: 50%; }
        .beat-dot.pulse { background: var(--p-purple); box-shadow: 0 0 6px var(--p-purple); }

        /* EXTRAS */
        .extras-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; }
        .perf-graph { height: 80px; background: #0f0f12; border: 1px solid #27272a; border-radius: 8px; display: flex; align-items: flex-end; padding: 5px; gap: 2px; }
        .graph-bar { flex: 1; background: #333; border-radius: 2px 2px 0 0; }
        .graph-bar.s-rank { background: var(--p-gold); }
        
        .tips-panel { background: #0f0f12; border: 1px solid #27272a; border-radius: 8px; padding: 10px; font-size: 0.7rem; color: #888; cursor: pointer; }
        .tips-content { display: none; margin-top: 5px; line-height: 1.4; }
        .tips-content.show { display: block; }
        
        .daily-goal { width: 100%; margin-bottom: 10px; }
        .daily-bar { width: 100%; height: 6px; background: #222; border-radius: 3px; overflow: hidden; margin-top: 5px; }
        .daily-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--p-blue), var(--p-purple)); transition: 0.5s; }

        /* ANIMATIONS */
        .viewport.shake { animation: shake 0.15s ease-out; }
        .viewport.chromatic { animation: chromatic 0.3s ease-out; }
        @keyframes shake { 0%, 100% { transform:translateX(0); } 25% { transform:translateX(-6px) rotate(-1deg); } 75% { transform:translateX(4px); } }
        @keyframes chromatic { 0% { filter: drop-shadow(4px 0 0 red) drop-shadow(-4px 0 0 cyan); } 100% { filter: none; } }
    </style>
</head>
<body>

    <a href="index.html" class="back-nav">‚Üê DASHBOARD</a>

    <div class="lab-card">
        <div class="daily-goal">
            <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#888;">
                <span>DAILY GOAL: S-RANKS</span>
                <span id="daily-text" style="color:#fff;">0/50</span>
            </div>
            <div class="daily-bar"><div class="daily-fill" id="daily-fill"></div></div>
        </div>

        <div class="stats-grid">
            <div class="bento-card card-hero">
                <span class="stat-label">LAST PEEK</span>
                <span class="hero-val" id="time-display">0<span style="font-size:1.5rem; color:#666">ms</span></span>
                <div class="rank-badge" id="rank-badge">-</div>
                <div style="font-size:0.7rem; color:var(--p-green); margin-top:5px;">AVG: <span id="avg-disp">0ms</span></div>
            </div>
            <div class="bento-card">
                <span class="stat-label">STREAK</span>
                <span class="stat-val" id="streak-disp">0</span>
            </div>
            <div class="bento-card">
                <span class="stat-label">ACCURACY</span>
                <span class="stat-val" id="acc-disp">0%</span>
            </div>
            <div class="bento-card card-wide">
                <span class="stat-label">RHYTHM SPLITS</span>
                <div style="display:flex; justify-content:space-around; width:100%; margin-top:5px;">
                    <div style="text-align:center"><div style="font-size:0.6rem; color:#666">1-2</div><div id="split-1" style="font-weight:bold">-</div></div>
                    <div style="text-align:center"><div style="font-size:0.6rem; color:#666">2-3</div><div id="split-2" style="font-weight:bold">-</div></div>
                    <div style="text-align:center"><div style="font-size:0.6rem; color:#666">3-4</div><div id="split-3" style="font-weight:bold">-</div></div>
                </div>
            </div>
        </div>

        <div class="viewport" id="viewport">
            <button class="theater-btn" onclick="toggleFullscreen()">‚õ∂ THEATER</button>
            <div class="feedback-text" id="feedback-text">READY</div>
            <div class="phase-indicator intel" id="phase-indicator">PHASE 1: INTEL</div>
            <div class="exposure-bar-container" id="exp-cont"><div class="exposure-bar" id="exp-bar"></div></div>
            <div class="crosshair"></div>
            
            <div class="combo-track" id="hud-keys">
                <div id="k0" class="key-node">A</div>
                <div id="k1" class="key-node">D</div>
                <div id="k2" class="key-node">E</div>
                <div id="k3" class="key-node">Q</div>
            </div>

            <div class="world-container" id="world">
                <div class="hallway">
                    <div class="floor"></div><div class="wall wall-left"></div><div class="wall wall-right"></div>
                    <div class="doorframe"><div class="door-col" style="left:0"></div><div class="door-col" style="right:0"></div></div>
                    <div class="enemy-target" id="enemy">
                        <div class="spotted-tag">SPOTTED</div>
                        <div class="enemy-head"></div><div class="enemy-body"></div>
                    </div>
                </div>
            </div>

            <div class="weapon-container">
                <div class="weapon-model" id="weapon">
                    <div class="gun-body"><div class="gun-optic"></div><div class="muzzle-flash" id="muzzle-flash"></div></div>
                </div>
            </div>
        </div>

        <div class="control-panel">
            <div class="top-row">
                <select class="mode-select" id="mode-select" onchange="setMode(this.value)">
                    <option value="full">FULL DRILL (Intel + Kill)</option>
                    <option value="intel">INTEL ONLY</option>
                    <option value="kill">KILL ONLY</option>
                    <option value="alt">ALTERNATING SIDES</option>
                </select>
                
                <div class="difficulty-row">
                    <button class="diff-btn" onclick="setBPM(80)">BEGINNER</button>
                    <button class="diff-btn active" onclick="setBPM(120)">INTERMEDIATE</button>
                    <button class="diff-btn" onclick="setBPM(160)">ADVANCED</button>
                    <button class="diff-btn" onclick="setBPM(200)">SHAIIKO</button>
                </div>
            </div>
            
            <div class="rhythm-bar">
                <div style="display:flex; align-items:center; gap:10px;">
                    <span style="font-size:0.7rem; color:#666; font-weight:bold">BPM</span>
                    <input type="range" class="bpm-slider" id="bpm-slider" min="60" max="220" value="120" oninput="setBPM(this.value)">
                    <span id="bpm-disp" style="font-weight:bold; width:30px; text-align:center;">120</span>
                </div>
                <button class="diff-btn" style="width:100px;" id="metro-btn" onclick="toggleMetronome()">METRONOME</button>
                <div class="beat-dots">
                    <div class="beat-dot" id="b1"></div><div class="beat-dot" id="b2"></div><div class="beat-dot" id="b3"></div><div class="beat-dot" id="b4"></div>
                </div>
            </div>
        </div>
        
        <button onclick="swapPeek()" style="width:100%; padding:10px; background:transparent; border:1px dashed #333; color:#555; cursor:pointer;">[SPACE] SWAP SIDE (Current: <span id="side-disp">RIGHT</span>)</button>

        <div class="extras-row">
            <div class="perf-graph" id="graph"></div>
            <div class="tips-panel" onclick="this.querySelector('.tips-content').classList.toggle('show')">
                <strong>üí° PRO TIPS</strong> <span style="float:right">‚ñº</span>
                <div class="tips-content">
                    ‚Ä¢ <strong>Intel Phase:</strong> Don't shoot! Just spot the target.<br>
                    ‚Ä¢ <strong>Kill Phase:</strong> Pre-fire on Step 3 (Lean).<br>
                    ‚Ä¢ <strong>Rhythm:</strong> Keep your key splits even.<br>
                    ‚Ä¢ <strong>DAQE:</strong> Left peek sequence is fixed now!
                </div>
            </div>
        </div>
        
        <div class="session-info" style="text-align:center; margin-top:10px; font-size:0.65rem; color:#555;">
            Session: <span id="sess-time">0:00</span> | Total Reps: <span id="sess-reps">0</span>
        </div>
    </div>

    <script>
        // --- LOGIC CONFIG ---
        // FIX: DAQE is now correct!
        const SEQS = { 'ADEQ': ['a','d','e','q'], 'DAQE': ['d','a','q','e'] }; 
        let currentSide = 'ADEQ'; // ADEQ = Right Peek, DAQE = Left Peek
        let trainingType = 'full';
        let phase = 'intel';
        let idx = 0;
        let startTime = 0;
        let keyTimes = [];
        
        // --- STATS ---
        let allTimes = [];
        let sRanks = 0;
        let streak = 0;
        let attempts = 0;
        let sessStart = Date.now();

        // --- AUDIO ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(freq, type='sine', dur=0.1) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.frequency.value = freq;
            osc.type = type;
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
            osc.start(); osc.stop(audioCtx.currentTime + dur);
        }
        function playSound(name) {
            if(name==='click') playTone(800, 'triangle', 0.05);
            if(name==='success') playTone(1200, 'sine', 0.2);
            if(name==='fail') playTone(150, 'sawtooth', 0.3);
            if(name==='shoot') playTone(100, 'square', 0.1);
        }

        // --- METRONOME ---
        let bpm = 120;
        let metroInterval = null;
        let beat = 0;
        function setBPM(val) {
            bpm = val;
            document.getElementById('bpm-slider').value = val;
            document.getElementById('bpm-disp').innerText = val;
            document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
            // Visual active state for buttons handled in click for simplicity
        }
        function toggleMetronome() {
            const btn = document.getElementById('metro-btn');
            if(metroInterval) {
                clearInterval(metroInterval); metroInterval = null;
                btn.style.background = ""; btn.style.color = "";
            } else {
                btn.style.background = "var(--p-purple)"; btn.style.color = "#fff";
                const ms = 60000 / bpm;
                metroInterval = setInterval(() => {
                    beat = (beat % 4) + 1;
                    document.querySelectorAll('.beat-dot').forEach(d => d.classList.remove('pulse'));
                    document.getElementById('b'+beat).classList.add('pulse');
                    playTone(beat===1?1000:600, 'sine', 0.05);
                }, ms);
            }
        }

        // --- VISUAL LOOP (LERP) ---
        let cx = 0, tx = 0, cLean = 0, tLean = 0;
        function loop() {
            cx += (tx - cx) * 0.15;
            cLean += (tLean - cLean) * 0.15;
            document.getElementById('world').style.transform = `translateX(${cx}px)`;
            document.getElementById('weapon').style.transform = `translateX(${cLean * 20}px) rotateZ(${cLean * 15}deg)`;
            requestAnimationFrame(loop);
        }
        loop();

        // --- GAMEPLAY ---
        function randomizeTarget() {
            const offset = (Math.random() * 60) - 30;
            const base = currentSide === 'ADEQ' ? 'calc(50% + 70px)' : 'calc(50% - 110px)';
            const el = document.getElementById('enemy');
            el.style.left = base;
            el.style.transform = `translateX(${offset}px)`;
            el.classList.remove('dead', 'spotted');
            if(phase === 'kill') el.classList.add('spotted');
        }

        let expTimer = null;
        function startExp() {
            const bar = document.getElementById('exp-bar');
            document.getElementById('exp-cont').classList.add('active');
            let s = performance.now();
            expTimer = setInterval(() => {
                let p = Math.min(100, (performance.now()-s)/300*100);
                bar.style.width = p + "%";
                if(p>=100) fail("TRADED");
            }, 16);
        }
        function stopExp() { clearInterval(expTimer); document.getElementById('exp-cont').classList.remove('active'); }

        window.addEventListener('keydown', e => {
            const k = e.key.toLowerCase();
            if(k === ' ') { e.preventDefault(); swapPeek(); return; }
            if(k === 'm') { toggleMetronome(); return; }
            if(k === 'r') { resetStats(); return; }

            const seq = SEQS[currentSide];
            if(k === seq[idx]) {
                if(idx === 0) { startTime = performance.now(); keyTimes = [startTime]; document.getElementById('k0').classList.add('active'); }
                else keyTimes.push(performance.now());
                
                playSound('click');
                document.getElementById('k'+idx).classList.add('hit');

                // Movement Pattern
                if(currentSide === 'ADEQ') { // Right Peek
                    if(idx===0) tx = 80;
                    if(idx===1) tx = -60;
                    if(idx===2) { tx = -80; tLean = 1; startExp(); }
                    if(idx===3) { tx = -40; tLean = -0.2; stopExp(); }
                } else { // Left Peek (DAQE)
                    if(idx===0) tx = -80;
                    if(idx===1) tx = 60;
                    if(idx===2) { tx = 80; tLean = -1; startExp(); }
                    if(idx===3) { tx = 40; tLean = 0.2; stopExp(); }
                }

                idx++;
                if(idx===4) finish();
            } else if(['a','d','e','q'].includes(k)) {
                fail("MISS");
            }
        });

        function finish() {
            const total = performance.now() - startTime;
            
            if(phase === 'intel') {
                document.getElementById('feedback-text').innerText = "SPOTTED";
                document.getElementById('feedback-text').className = "feedback-text show";
                document.getElementById('enemy').classList.add('spotted');
                playSound('success');
                recordStats(total, 'INTEL');
                
                if(trainingType === 'full' || trainingType === 'alt') {
                    phase = 'kill';
                    updatePhaseUI();
                }
            } else {
                document.getElementById('muzzle-flash').classList.add('active');
                document.getElementById('enemy').classList.add('dead');
                playSound('shoot');
                
                const target = (60000/bpm)*3;
                let rank = total < target*0.85 ? 'S' : (total < target ? 'A' : 'D');
                
                const fb = document.getElementById('feedback-text');
                fb.innerText = rank==='S'?"GODLIKE":"CLEAN";
                fb.style.color = rank==='S'?"var(--p-gold)":"#fff";
                fb.className = "feedback-text show";
                if(rank==='S') { document.getElementById('viewport').classList.add('shake'); sRanks++; }
                
                recordStats(total, rank);
                
                if(trainingType === 'full' || trainingType === 'alt') {
                    phase = 'intel';
                    updatePhaseUI();
                    if(trainingType === 'alt') swapPeek(false);
                }
            }
            setTimeout(resetRound, 200);
        }

        function fail(reason) {
            stopExp();
            document.getElementById('viewport').classList.add('chromatic');
            const fb = document.getElementById('feedback-text');
            fb.innerText = reason; fb.style.color = "var(--p-red)"; fb.className = "feedback-text show";
            playSound('fail');
            streak = 0;
            updateHUD(0, 'F');
            setTimeout(resetRound, 200);
        }

        function resetRound() {
            idx = 0; tx = 0; tLean = 0;
            document.querySelectorAll('.key-node').forEach(k => k.className = 'key-node');
            document.getElementById('muzzle-flash').classList.remove('active');
            document.getElementById('viewport').classList.remove('shake');
            document.getElementById('viewport').classList.remove('chromatic');
            document.getElementById('feedback-text').className = "feedback-text";
            randomizeTarget();
        }

        // --- UI & DATA ---
        function recordStats(ms, rank) {
            allTimes.push(ms); attempts++;
            if(rank !== 'F' && rank !== 'MISS') streak++; else streak = 0;
            
            // Graph
            const bar = document.createElement('div');
            bar.className = `graph-bar ${rank.toLowerCase()}-rank`;
            bar.style.height = Math.min(100, (ms/1000)*100) + "%";
            const g = document.getElementById('graph');
            g.appendChild(bar);
            if(g.children.length > 30) g.removeChild(g.children[0]);
            
            // Splits
            if(keyTimes.length === 4) {
                document.getElementById('split-1').innerText = Math.round(keyTimes[1]-keyTimes[0]);
                document.getElementById('split-2').innerText = Math.round(keyTimes[2]-keyTimes[1]);
                document.getElementById('split-3').innerText = Math.round(keyTimes[3]-keyTimes[2]);
            }
            updateHUD(ms, rank);
        }

        function updateHUD(ms, rank) {
            if(ms) document.getElementById('time-display').innerHTML = Math.round(ms) + '<span style="font-size:1.5rem; color:#666">ms</span>';
            if(rank) { 
                const rb = document.getElementById('rank-badge');
                rb.innerText = rank; rb.className = `rank-badge rank-${rank}`;
            }
            const avg = allTimes.length ? Math.round(allTimes.reduce((a,b)=>a+b)/allTimes.length) : 0;
            document.getElementById('avg-disp').innerText = avg + "ms";
            document.getElementById('streak-disp').innerText = streak;
            document.getElementById('acc-disp').innerText = attempts ? Math.round((sRanks/attempts)*100)+"%" : "0%";
            document.getElementById('daily-text').innerText = sRanks+"/50";
            document.getElementById('daily-fill').style.width = (sRanks/50)*100+"%";
            document.getElementById('sess-reps').innerText = attempts;
        }

        function swapPeek(reset=true) {
            currentSide = currentSide === 'ADEQ' ? 'DAQE' : 'ADEQ';
            document.getElementById('side-disp').innerText = currentSide === 'ADEQ' ? 'RIGHT' : 'LEFT';
            
            const k = document.querySelectorAll('.key-node');
            if(currentSide === 'ADEQ') { k[0].innerText='A'; k[1].innerText='D'; k[3].innerText='Q'; }
            else { k[0].innerText='D'; k[1].innerText='A'; k[3].innerText='E'; }
            if(reset) resetRound();
        }

        function setMode(val) {
            trainingType = val;
            phase = (val === 'kill') ? 'kill' : 'intel';
            updatePhaseUI();
            resetRound();
        }

        function updatePhaseUI() {
            const pi = document.getElementById('phase-indicator');
            pi.innerText = phase === 'kill' ? "PHASE 2: KILL" : "PHASE 1: INTEL";
            pi.className = phase === 'kill' ? "phase-indicator kill" : "phase-indicator intel";
        }

        function toggleFullscreen() {
            if(!document.fullscreenElement) { document.body.requestFullscreen(); document.body.classList.add('theater-mode'); }
            else { document.exitFullscreen(); document.body.classList.remove('theater-mode'); }
        }
        
        function resetStats() {
            allTimes = []; sRanks = 0; streak = 0; attempts = 0;
            document.getElementById('graph').innerHTML = '';
            updateHUD();
        }

        setInterval(() => {
            const s = Math.floor((Date.now()-sessStart)/1000);
            document.getElementById('sess-time').innerText = `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;
        }, 1000);

        randomizeTarget();
    </script>
</body>
</html>
