<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R6 Neuro-Trainer</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéØ</text></svg>">
    <style>
        :root {
            --bg-color: #09090b;
            --panel-color: #18181b;
            --accent-color: #8b5cf6;
            --enemy-head: #71717a;
            --enemy-body: #27272a;
        }

        body {
            background-color: var(--bg-color);
            background-image: 
                linear-gradient(rgba(139, 92, 246, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(139, 92, 246, 0.03) 1px, transparent 1px);
            background-size: 30px 30px;
            color: #fff;
            font-family: 'Segoe UI', system-ui, sans-serif;
            margin: 0;
            overflow: hidden;
            display: flex;
            height: 100vh;
            user-select: none;
        }

        /* --- NAVIGATION BUTTON --- */
        .home-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: #27272a;
            color: #a1a1aa;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 6px;
            border: 1px solid #3f3f46;
            font-weight: 700;
            font-size: 0.8rem;
            transition: 0.2s;
        }
        .home-btn:hover {
            border-color: #fff;
            color: #fff;
        }

        /* --- GAME AREA --- */
        #game-wrapper {
            flex: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: crosshair;
            border-right: 1px solid #333;
        }

        #game-container {
            position: relative;
            width: 800px; height: 500px;
            background: radial-gradient(circle at center, #27272a 0%, #000 100%);
            border: 2px solid #333;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 0 60px rgba(0,0,0,0.6);
        }

        .head-line { position: absolute; top: 345px; width: 100%; height: 1px; background: rgba(255,255,255,0.05); pointer-events: none; }
        .wall { position: absolute; right: 0; top: 0; width: 400px; height: 100%; background: #09090b; border-left: 4px solid #000; z-index: 20; }
        
        #enemy { position: absolute; right: 10px; bottom: 140px; width: 60px; height: 140px; z-index: 10; will-change: transform; }
        .head { width: 30px; height: 30px; border-radius: 50%; margin: 0 auto; border: 1px solid #555; position: relative; top: 5px; z-index: 12; transition: 0.2s; }
        .body { width: 60px; height: 100px; border-radius: 8px; margin-top: 5px; box-shadow: inset 0 0 10px rgba(0,0,0,0.9); transition: 0.2s; }
        .gun { width: 50px; height: 8px; background: #000; position: absolute; top: 50px; left: -10px; }

        .hostile .head { background-color: var(--enemy-head); }
        .hostile .body { background-color: var(--enemy-body); }
        .friendly .head { background-color: #3b82f6; border-color: #60a5fa; }
        .friendly .body { background-color: #1e3a8a; }

        .swing-anim { transition: transform 0.2s cubic-bezier(0.1, 0.7, 1.0, 0.1); transform: translateX(-410px) !important; }
        .enemy-hit { transform: translateX(-410px) rotate(-90deg) translateY(100px) !important; transition: transform 0.3s ease-in !important; filter: grayscale(100%); opacity: 0.5; }

        #feedback-msg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 5rem; font-weight: 900; z-index: 100; text-shadow: 0 0 30px #000; display: none; }
        
        #start-msg { 
            position: absolute; 
            bottom: 40px; 
            width: 100%; 
            text-align: center; 
            color: #fff; 
            font-weight: 600; 
            letter-spacing: 1px; 
            pointer-events: none; 
            z-index: 100; 
            text-shadow: 0 2px 4px #000;
        }

        /* --- COACH PANEL --- */
        #coach-panel {
            flex: 1;
            background: var(--panel-color);
            padding: 30px;
            display: flex; flex-direction: column; gap: 20px;
            overflow-y: auto;
        }

        .panel-header { font-size: 1.8rem; font-weight: 800; color: var(--accent-color); margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .section-title { font-size: 0.8rem; font-weight: 700; color: #a1a1aa; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 1px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-card { background: #27272a; padding: 15px; border-radius: 8px; border: 1px solid #3f3f46; text-align: center; }
        .stat-val { font-size: 2rem; font-weight: 800; color: #fff; }
        .stat-label { font-size: 0.7rem; color: #a1a1aa; text-transform: uppercase; }

        .analysis-box { background: rgba(139, 92, 246, 0.05); border: 1px solid rgba(139, 92, 246, 0.2); border-left: 4px solid var(--accent-color); padding: 20px; border-radius: 6px; }
        .focus-badge { display: inline-block; background: var(--accent-color); color: #fff; font-weight: 700; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; margin-bottom: 10px; }
        .advice-text { font-size: 0.9rem; line-height: 1.6; color: #e4e4e7; }
        .drill-box { background: #202024; padding: 15px; border-radius: 6px; margin-top: 15px; border: 1px dashed #555; }
        .drill-title { color: #fff; font-weight: 700; font-size: 0.85rem; margin-bottom: 5px; text-transform: uppercase; }

        .chart-box { height: 80px; display: flex; align-items: flex-end; gap: 4px; padding-bottom: 5px; border-bottom: 1px solid #333; }
        .bar { flex: 1; background: #3f3f46; border-radius: 2px 2px 0 0; min-height: 4px; transition: height 0.3s; }

        .btn-group { display: flex; gap: 10px; margin-top: auto; }
        .btn { padding: 12px; background: #27272a; border: 1px solid #3f3f46; color: #fff; font-weight: 700; cursor: pointer; border-radius: 6px; flex: 1; }
        .btn:hover { border-color: var(--accent-color); color: var(--accent-color); }
        .btn-audio.active { background: #2e1065; border-color: var(--accent-color); color: #c4b5fd; box-shadow: 0 0 10px rgba(139, 92, 246, 0.3); }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0a0a0a; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-color); }

    </style>
</head>
<body>

    <a href="index.html" class="home-btn">‚Üê DASHBOARD</a>

    <div id="game-wrapper" onmousedown="handleClick(event)">
        <div id="game-container">
            <div id="feedback-msg">PERFECT</div>
            <div id="start-msg">CLICK TO START SESSION</div>
            
            <div class="head-line"></div>
            <div id="enemy" class="hostile"><div class="head"></div><div class="body"><div class="gun"></div></div></div>
            <div class="wall"></div>
        </div>
    </div>

    <div id="coach-panel">
        <div class="panel-header">NEURO-TRAINER</div>
        
        <div class="grid-2">
            <div class="stat-card">
                <div class="stat-val" id="avg-disp">--</div>
                <div class="stat-label">AVG REACTION (MS)</div>
            </div>
            <div class="stat-card">
                <div class="stat-val" id="score-disp">--</div>
                <div class="stat-label">CONSISTENCY SCORE</div>
            </div>
        </div>

        <div>
            <div class="section-title">History</div>
            <div class="chart-box" id="history-chart"></div>
        </div>

        <div>
            <div class="section-title">Performance Psychology</div>
            <div class="analysis-box" id="analysis-content">
                <div style="color:#71717a; font-style: italic;">
                    Gathering biometrics... Complete 5 rounds to unlock analysis.
                </div>
            </div>
        </div>

        <div class="btn-group">
            <button class="btn btn-audio" id="noise-btn" onclick="toggleBrownNoise()">üîä BROWN NOISE</button>
            <button class="btn" onclick="resetData()">RESET</button>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const enemyEl = document.getElementById('enemy');
        const feedbackMsg = document.getElementById('feedback-msg');
        const startMsg = document.getElementById('start-msg');
        
        // Coach Elements
        const avgDisp = document.getElementById('avg-disp');
        const scoreDisp = document.getElementById('score-disp');
        const chartBox = document.getElementById('history-chart');
        const analysisContent = document.getElementById('analysis-content');
        const noiseBtn = document.getElementById('noise-btn');

        // State
        let state = "IDLE"; 
        let swingStart = 0;
        let swingTimer = null;
        let isFriendly = false;
        let history = []; 
        let errors = 0;   

        // --- AUDIO ENGINE ---
        let audioCtx = null;
        let noiseSource = null;
        let gainNode = null;
        let isNoisePlaying = false;

        function toggleBrownNoise() {
            try {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                
                if (isNoisePlaying) {
                    if (noiseSource) noiseSource.stop();
                    noiseBtn.classList.remove('active');
                    isNoisePlaying = false;
                } else {
                    if (audioCtx.state === 'suspended') audioCtx.resume();
                    
                    const bufferSize = audioCtx.sampleRate * 2; 
                    const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
                    const data = buffer.getChannelData(0);
                    
                    let lastOut = 0;
                    for (let i = 0; i < bufferSize; i++) {
                        const white = Math.random() * 2 - 1;
                        lastOut = (lastOut + (0.02 * white)) / 1.02; 
                        lastOut *= 3.5; 
                        data[i] = lastOut;
                    }

                    noiseSource = audioCtx.createBufferSource();
                    noiseSource.buffer = buffer;
                    noiseSource.loop = true;
                    
                    gainNode = audioCtx.createGain();
                    gainNode.gain.value = 0.15; 
                    
                    noiseSource.connect(gainNode);
                    gainNode.connect(audioCtx.destination);
                    noiseSource.start();
                    
                    noiseBtn.classList.add('active');
                    isNoisePlaying = true;
                }
            } catch (e) {
                console.error("Audio Error:", e);
                alert("Audio start failed. Please click the page first.");
            }
        }

        // --- GAME ENGINE ---
        function handleClick(e) {
            // SAFETY: Do not shoot if clicking the Panel OR the Home Button
            if (e && (e.target.closest('#coach-panel') || e.target.closest('.home-btn'))) return;

            if (state === "IDLE" || state === "ENDED") return startRound();
            if (state === "HOLDING") return endRound("EARLY");
            if (state === "SWINGING") {
                if (isFriendly) return endRound("TK");
                const ms = Date.now() - swingStart;
                history.push(ms);
                endRound("HIT", ms);
            }
        }

        function startRound() {
            state = "HOLDING";
            clearTimeout(swingTimer);
            isFriendly = false;
            
            feedbackMsg.style.display = "none";
            startMsg.style.opacity = "0";
            enemyEl.className = "hostile"; 
            void enemyEl.offsetWidth; 

            if (Math.random() < 0.2) {
                isFriendly = true;
                enemyEl.className = "friendly";
            } else {
                enemyEl.className = "hostile";
            }

            const delay = Math.random() * 2000 + 1500;
            swingTimer = setTimeout(() => {
                if (state === "HOLDING") {
                    state = "SWINGING";
                    swingStart = Date.now();
                    enemyEl.classList.add("swing-anim");
                    
                    if (isFriendly) {
                        setTimeout(() => {
                            if (state === "SWINGING") endRound("PASS");
                        }, 800);
                    }
                }
            }, delay);
        }

        function endRound(type, ms = 0) {
            state = "ENDED";
            let txt = "", col = "#fff";

            if (type === "EARLY") {
                txt = "IMPULSE ERROR"; col = "#eab308"; errors++;
                enemyEl.classList.add("swing-anim");
            } else if (type === "TK") {
                txt = "TEAM KILL"; col = "#ef4444"; errors++;
            } else if (type === "PASS") {
                txt = "DISCIPLINED"; col = "#3b82f6";
            } else if (type === "HIT") {
                txt = ms + " MS"; 
                col = ms < 220 ? "#38bdf8" : (ms < 300 ? "#22c55e" : "#fff");
                enemyEl.classList.add("enemy-hit");
            }

            feedbackMsg.innerText = txt;
            feedbackMsg.style.color = col;
            feedbackMsg.style.display = "block";
            
            updateCoach();
            setTimeout(() => { startMsg.style.opacity = "1"; startMsg.innerText = "CLICK TO CONTINUE"; }, 600);
        }

        // --- COACHING LOGIC ---
        function updateCoach() {
            if (history.length === 0) return;
            const sum = history.reduce((a,b)=>a+b, 0);
            const avg = Math.round(sum / history.length);
            avgDisp.innerText = avg;

            const mean = sum / history.length;
            const variance = history.reduce((a,b) => a + Math.pow(b - mean, 2), 0) / history.length;
            const stdDev = Math.sqrt(variance);
            
            let grade = "C";
            let gradeCol = "#fff";
            if (stdDev < 15) { grade = "A+"; gradeCol = "#38bdf8"; }
            else if (stdDev < 30) { grade = "A"; gradeCol = "#22c55e"; }
            else if (stdDev < 50) { grade = "B"; gradeCol = "#eab308"; }
            else { grade = "D"; gradeCol = "#ef4444"; }
            
            scoreDisp.innerText = grade;
            scoreDisp.style.color = gradeCol;

            chartBox.innerHTML = "";
            history.slice(-15).forEach(val => {
                const bar = document.createElement('div');
                bar.className = 'bar';
                let h = Math.max(10, 100 - (val - 150)/3);
                bar.style.height = h + "%";
                bar.style.backgroundColor = val < 250 ? "#8b5cf6" : "#3f3f46";
                chartBox.appendChild(bar);
            });

            if (history.length >= 5) generatePsychAdvice(avg, stdDev, errors);
        }

        function generatePsychAdvice(avg, dev, err) {
            let focus = "ANALYZING";
            let tip = "";
            let drill = "";

            if (err > 2) {
                focus = "IMPULSE CONTROL";
                tip = "Your brain is bypassing verification to gain speed. This causes panic-spraying in game. You must decouple the stimulus (movement) from the action (clicking) until color is verified.";
                drill = "Say the word 'Blue' or 'Grey' out loud BEFORE clicking. This forces cognitive processing over reflex.";
            } else if (dev > 40) {
                focus = "MENTAL NOISE";
                tip = "High variance suggests 'Mental Flicker'. You are likely holding your breath or tensing up too early. Use the Brown Noise feature to mask external distractions.";
                drill = "The 4-7-8 Breathing Technique. Inhale 4s, Hold 7s, Exhale 8s. Reset your vagus nerve between attempts.";
            } else if (avg < 210) {
                focus = "FLOW STATE";
                tip = "You are in Flow. Your subconscious is handling the load. Do not overthink it. Conscious thought will actually slow you down now.";
                drill = "Maintain 'Soft Focus'. Look 'through' the monitor rather than at a specific pixel. Rely on peripheral detection.";
            } else {
                focus = "PHYSIOLOGICAL LATENCY";
                tip = "You are consistent but fighting biological delay. We need to reduce the physical travel time of your finger.";
                drill = "Pre-Tensioning: Rest your finger on the mouse button with 90% of the force required to click. Remove the 'slack' from your muscle/switch.";
            }

            analysisContent.innerHTML = `
                <div class="focus-badge">${focus}</div>
                <div class="advice-text">${tip}</div>
                <div class="drill-box">
                    <div class="drill-title">RECOMMENDED TRAINING:</div>
                    <div class="advice-text" style="color:#a1a1aa;">${drill}</div>
                </div>
            `;
        }

        function resetData() {
            history = [];
            errors = 0;
            avgDisp.innerText = "--";
            scoreDisp.innerText = "--";
            chartBox.innerHTML = "";
            analysisContent.innerHTML = '<div style="color:#71717a; font-style:italic;">Session reset. Awaiting data...</div>';
        }
    </script>
</body>
</html>
